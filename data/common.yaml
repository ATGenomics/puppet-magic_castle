---
consul_template::version: 0.25.0
consul::version: 1.7.4
consul_template::config_hash:
  consul:
    token: "%{hiera('profile::consul::acl_api_token')}"

fail2ban::package_name: fail2ban-server
fail2ban::jails: ['ssh-route', 'ssh-ban-root']
fail2ban::custom_jails:
  'ssh-route':
    enabled: true
    filter: 'sshd'
    findtime: 3600
    bantime: 86400
    maxretry: 20
    action: 'route'
    logpath: '%(sshd_log)s'
  'ssh-ban-root':
    enabled: true
    findtime: 3600
    bantime: 86400
    maxretry: 0
    action: 'route'
    logpath: '%(sshd_log)s'
    journalmatch: '_SYSTEMD_UNIT=sshd.service + _COMM=sshd'
    filter_maxlines: 10
    filter_includes: 'before = common.conf'
    filter_failregex: '^%(__prefix_line)spam_unix\(sshd:auth\):\s+authentication failure;\s*logname=\S*\s*uid=\d*\s*euid=\d*\s*tty=\S*\s*ruser=\S*\s*rhost=<HOST>\S*\s*user=(root|admin)\s.*$'

jupyterhub::kernel::setup: venv
jupyterhub::kernel::venv::python: /cvmfs/soft.computecanada.ca/easybuild/software/2017/Core/python/3.7.4/bin/python
jupyterhub::kernel::venv::pip_environment:
  PYTHONPATH: "/cvmfs/soft.computecanada.ca/custom/python/site-packages"
  PIP_CONFIG_FILE: "/cvmfs/soft.computecanada.ca/config/python/pip-avx2.conf"

squid::acls:
  SSL_ports:
    type: port
    entries:
      - '443'
  Safe_ports:
    type: port
    entries:
      - '80'
      - '443'
      - '1025-65535'
  CONNECT:
    type: method
    entries:
      - CONNECT
  CC_CVMFS:
    type: dstdom_regex
    entries:
      - '^(cvmfs-.*\.computecanada\.ca)$'
      - '^(.*-cvmfs\.openhtc\.io)$'
      - '^(cvmfs-.*\.genap\.ca)$'
squid::http_access:
  'manager localhost':
    action: allow
  'manager':
    action: deny
  '!Safe_ports':
    action: deny
  'CONNECT !SSL_ports':
    action: deny
  'CLUSTER_NETWORK CC_CVMFS':
    action: allow
  localhost:
    action: allow
  all:
    action: deny
squid::http_ports:
  "%{hiera('profile::squid::port')}": {}
squid::coredump_dir: /var/spool/squid
squid::maximum_object_size_in_memory: "512 KB"
squid::forwarded_for: on
squid::via: on
squid::access_log: "/var/log/squid/access.log"
squid::cache_mem: "256 MB"
squid::refresh_patterns:
  '.':
    min:     0
    percent: 20
    max:     4320
squid::cache_dirs:
  '/var/spool/squid':
    type: 'ufs'
    options: "%{hiera('profile::squid::cache_size')} 16 256"